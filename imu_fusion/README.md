# IMU九轴融合算法

> ✅ **通用算法模块** - 纯软件算法，无硬件依赖

## 功能特性

- **Madgwick算法**：快速四元数姿态更新
- **卡尔曼滤波**：Yaw角度精化
- **九轴融合**：加速度计+陀螺仪+磁力计
- **自适应参数**：根据运动状态动态调整
- **高精度**：融合后姿态精度±0.5°

## 使用场景

✅ **适用于**：
- 自制IMU姿态解算
- 多传感器数据融合
- 学习理解融合算法原理
- 需要自定义融合参数的场景

⚠️ **不适用于**：
- 有现成带DMP的IMU模块（直接用硬件融合更快）
- 对算法原理不了解的快速开发

## 算法原理

### Madgwick算法

基于梯度下降法的四元数姿态估计：
- **输入**：加速度、陀螺仪、磁力计原始数据
- **输出**：四元数（可转换为欧拉角）
- **优势**：计算量小，实时性好
- **参数**：
  - `beta = 0.08f`：算法增益（越大收敛越快但抖动越大）
  - `Kp = 15.0f`：比例增益
  - `Ki = 0.0005f`：积分增益

### 卡尔曼滤波

用于Yaw角的精化处理：
- **过程噪声** `q = 0.001f`
- **测量噪声** `r = 0.3f`
- **作用**：平滑磁力计噪声，减少Yaw漂移

## 配置说明

### 算法参数调整

```c
// 在mcu_dmp.c中修改参数

// Madgwick算法增益（影响收敛速度）
#define BETA 0.08f  // 0.05~0.2，默认0.08

// PID参数
#define Kp 15.0f    // 比例增益
#define Ki 0.0005f  // 积分增益

// 卡尔曼滤波参数
kalman.q = 0.001f;  // 过程噪声（越小越信任模型）
kalman.r = 0.3f;    // 测量噪声（越大越平滑）
```

## API使用示例

```c
#include "mcu_dmp.h"

// 1. 初始化IMU融合算法
imu_init();

// 2. 主循环中更新数据
while(1) {
    // 从传感器读取原始数据
    float accel[3], gyro[3], mag[3];
    read_sensor_data(accel, gyro, mag);  // 用户自己实现

    // 更新融合算法（输入单位：m/s², rad/s, uT）
    imu_update(accel[0], accel[1], accel[2],
               gyro[0], gyro[1], gyro[2],
               mag[0], mag[1], mag[2],
               0.01f);  // 采样周期（秒），100Hz=0.01s

    // 获取欧拉角
    EulerAngles angles;
    imu_get_euler_angles(&angles);
    printf("Roll: %.2f, Pitch: %.2f, Yaw: %.2f\n",
           angles.roll, angles.pitch, angles.yaw);

    HAL_Delay(10);  // 100Hz更新
}
```

## 主要API

| 函数 | 功能 | 参数说明 |
|------|------|----------|
| `imu_init()` | 初始化融合算法 | 无 |
| `imu_update(...)` | 更新融合数据 | 9轴数据+采样周期 |
| `imu_get_euler_angles(e)` | 获取欧拉角 | 输出：roll/pitch/yaw（°） |
| `kalman_filter(k, input)` | 卡尔曼滤波 | 单独调用滤波器 |
| `invSqrt(x)` | 快速反平方根 | Quake算法优化 |

## 数据结构

```c
// 3轴向量
typedef struct {
    float x, y, z;
} Axis3f;

// 欧拉角
typedef struct {
    float roll;   // 横滚角（°）
    float pitch;  // 俯仰角（°）
    float yaw;    // 偏航角（°）
} EulerAngles;

// 卡尔曼滤波器
typedef struct {
    float x;      // 状态估计
    float p;      // 误差协方差
    float q;      // 过程噪声
    float r;      // 测量噪声
    float k;      // 卡尔曼增益
} KalmanFilter;
```

## 性能参数

| 参数 | 规格 |
|------|------|
| 姿态精度 | ±0.5°（融合后） |
| 更新频率 | 50Hz ~ 500Hz |
| CPU占用 | ~5%（100Hz@STM32F4） |
| 内存占用 | ~1KB RAM |
| 收敛时间 | 1~2秒 |

## 参数调优指南

### Beta参数

- **增大**：收敛快，但抖动大（适合快速运动）
- **减小**：平滑稳定，但响应慢（适合缓慢运动）
- 推荐值：0.05~0.15

### Kp/Ki参数

- **Kp大**：响应快，但可能超调
- **Ki大**：消除静差，但收敛慢
- 典型值：Kp=10~20, Ki=0.0001~0.001

### 卡尔曼滤波

- **q小**：更信任模型预测（平滑）
- **r大**：更信任测量值（响应快）
- 典型值：q=0.001, r=0.1~0.5

## 注意事项

1. **坐标系**：算法假设右手坐标系（X前Y右Z上）
2. **单位转换**：
   - 加速度：m/s²（1g = 9.8m/s²）
   - 角速度：rad/s（需将°/s转换）
   - 磁场：μT（任意单位，会自动归一化）
3. **磁力计校准**：使用前必须校准，否则Yaw角不准
4. **采样频率**：建议100Hz以上，太低会影响精度
5. **初始姿态**：上电时应静止放置，等待收敛

## 依赖项

- **WP_Math高性能数学库**（可选，提升性能）
- 无硬件依赖

## 与其他方案对比

| 方案 | 优势 | 劣势 |
|------|------|------|
| 硬件DMP（MPU6050） | 省CPU，稳定 | 无磁力计，Yaw漂移 |
| 软件融合（本模块） | 灵活可调，九轴融合 | 占用CPU |
| Kalman滤波 | 理论最优 | 计算量大，参数多 |
| 互补滤波 | 简单快速 | 精度一般 |
